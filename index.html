<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaster Ranker</title>
    <link rel="icon" href="/images/rollercoaster.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-inner">
                <div class="header-left">
                    <div class="current-user-badge" id="currentUserBadge">Select a user</div>
                </div>

                <div class="header-center">
                    <h1>Coaster Ranker</h1>
                </div>

                <div class="header-right">
                    <button id="userMenuToggle" class="hamburger-btn" aria-haspopup="true" aria-expanded="false" title="Choose user" onclick="toggleUserMenu()">‚ò∞</button>
                    <div id="userMenu" class="user-menu" aria-hidden="true">
                        <button class="user-btn" onclick="switchUser('luca')" id="btn-luca">üë§ Luca</button>
                        <button class="user-btn" onclick="switchUser('wouter')" id="btn-wouter">üë§ Wouter</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('battle')">
                <span class="tab-icon"><img src="/images/sword.svg" alt="Battle" style="width: 1em; height: 1em;"></span>
                <span class="tab-text">Battle</span>
            </button>
            <button class="tab" onclick="switchTab('ranking')">
                <span class="tab-icon"><img src="/images/chart-line-up.svg" alt="Ranking" style="width: 1em; height: 1em;"></span>
                <span class="tab-text">Ranking</span>
            </button>
            <button class="tab" onclick="switchTab('history')">
                <span class="tab-icon"><img src="/images/scroll.svg" alt="History" style="width: 1em; height: 1em;"></span>
                <span class="tab-text">History</span>
            </button>
            <button class="tab" onclick="switchTab('achievements')">
                <span class="tab-icon"><img src="/images/trophy.svg" alt="Achievements" style="width: 1em; height: 1em;"></span>
                <span class="tab-text">Achievements</span>
            </button>
        </div>

        <div id="battle-tab" class="tab-content active">
            <div class="vs-divider">VS</div>
            <div class="battle-area">
            <div class="battle-container" id="battleContainer">
                <div class="no-battles">Select a user above first! üëÜ</div>
            </div>
        
            </div>
        </div>
        <div id="history-tab" class="tab-content">
            <div class="history-header-row">
                <div class="autocomplete-container">
                    <div class="search-input-wrapper">
                        <input id="historySearch" type="text" class="search-box" placeholder="üîç Search matchup..." oninput="handleHistorySearchInput()" onkeydown="handleHistorySearchKeydown(event)" onfocus="showHistoryAutocomplete()" style="width:100%;" />
                        <button id="clearHistorySearchBtn" class="clear-search-btn" onclick="clearHistorySearch()" style="display:none;" title="Clear search">‚úï</button>
                    </div>
                    <div id="historyAutocomplete" class="autocomplete-dropdown"></div>
                </div>
                <!-- History Filters: visible when a coaster is selected -->
                <div class="history-filters" id="historyFilters" aria-hidden="false">
                    <button class="filter-btn active" data-filter="all" onclick="setHistoryFilter('all')">All battles</button>
                    <button class="filter-btn" data-filter="wins" onclick="setHistoryFilter('wins')">Wins</button>
                    <button class="filter-btn" data-filter="losses" onclick="setHistoryFilter('losses')">Losses</button>
                    <button class="filter-btn" data-filter="close" onclick="setHistoryFilter('close')">Close fights</button>
                </div>
            </div>
            <div id="historyContainer" style="overflow:auto;">
                <div class="no-battles">No battles yet ‚Äî start choosing to build your history.</div>
            </div>
        </div>

        <div id="ranking-tab" class="tab-content">
            <div class="ranking-controls">
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-value" id="totalBattles">0</div>
                        <div class="stat-label">Total Battles</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalCoasters">0</div>
                        <div class="stat-label">Coasters</div>
                    </div>
                    <div class="stat-item" style="display: none;">
                        <div class="stat-value" id="avgBattlesPerCoaster">0</div>
                        <div class="stat-label">Avg. Battles/Coaster</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="progressMatchups">0/0</div>
                        <div class="stat-label">Matchups Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="progressPercentage">0%</div>
                        <div class="stat-label">Progress</div>
                    </div>
                </div>
            </div>

            <div class="filter-container">
                <input type="text" class="search-box" id="searchBox" placeholder="üîç Search coaster, park or manufacturer..." onkeyup="filterRanking()">
            </div>

            <table class="ranking-table" id="rankingTable">
                <thead>
                    <tr>
                        <th onclick="sortRanking('rank')">Rank</th>
                        <th onclick="sortRanking('name')">Name</th>
                        <th onclick="sortRanking('park')">Park</th>
                        <th onclick="sortRanking('manufacturer')">Manufacturer</th>
                        <th onclick="sortRanking('elo')">ELO ‚¨áÔ∏è</th>
                        <th onclick="sortRanking('battles')">Battles</th>
                        <th onclick="sortRanking('wins')">Wins</th>
                        <th onclick="sortRanking('losses')">Losses</th>
                    </tr>
                </thead>
                <tbody id="rankingBody">
                    <tr><td colspan="8" class="no-battles">Select a user first! üé¢</td></tr>
                </tbody>
            </table>

            <div class="reset-panel">
                <div class="reset-copy">Reset all rankings, battles and history for the current user.</div>
                <button class="reset-btn" onclick="resetRankings()">üîÑ Reset All</button>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="download-btn" onclick="downloadRankingCSV()" style="background: linear-gradient(135deg, #4CA1AF 0%, #2C3E50 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 1em; font-weight: 700; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 15px rgba(76, 161, 175, 0.3);">
                    üì• Download Ranking as CSV
                </button>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div id="achievements-tab" class="tab-content">
            <div class="achievement-filters">
                <button class="filter-tag active" data-category="all" onclick="filterAchievements('all')">
                    All
                </button>
                <button class="filter-tag" data-category="battles" onclick="filterAchievements('battles')">
                    ‚öîÔ∏è Battles
                </button>
                <button class="filter-tag" data-category="close-fights" onclick="filterAchievements('close-fights')">
                    üí• Close Fights
                </button>
                <button class="filter-tag" data-category="patterns" onclick="filterAchievements('patterns')">
                    üîÑ Patterns
                </button>
                <button class="filter-tag" data-category="collection" onclick="filterAchievements('collection')">
                    üåç Collection
                </button>
                <button class="filter-tag" data-category="siblings" onclick="filterAchievements('siblings')">
                    üëØ Siblings
                </button>
                <button class="filter-tag" data-category="ranking" onclick="filterAchievements('ranking')">
                    üìä Ranking
                </button>
                <button class="filter-tag" data-category="special" onclick="filterAchievements('special')">
                    ‚ú® Special
                </button>
            </div>
            <div class="achievements-grid" id="achievementsGrid">
                <!-- Achievement cards will be inserted here dynamically -->
            </div>
        </div>
    </div>

    <!-- Developer button (bottom-left) -->
    <button id="devToggleBtn" class="dev-toggle dev-btn" aria-haspopup="true" aria-expanded="false" title="Developer options" onclick="toggleDevMenu()">
        <svg class="icon icon-gear" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false">
            <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zm8.2-3a6.7 6.7 0 0 0-.1-1l2.1-1.6-2-3.4-2.5.6a7 7 0 0 0-1.6-.9L15 2h-6l-.6 2.2c-.5.2-1 .5-1.6.9L4.3 4.5 2.3 7.9l2.1 1.6c-.1.3-.1.6-.1 1s0 .7.1 1L2.3 15.1 4.3 18.5l2.5-.6c.5.4 1.1.7 1.6.9L9 22h6l.6-2.2c.5-.2 1-.5 1.6-.9l2.5.6 2-3.4-2.1-1.6c.1-.3.1-.6.1-1z"/>
        </svg>
    </button>
    <div id="devMenu" class="dev-menu" aria-hidden="true" role="dialog" aria-label="Developer options">
        <div class="dev-menu-header">Developer Options</div>
        <div class="dev-menu-body">
            <div class="dev-option">
                <div style="display:flex;gap:8px;align-items:center;">
                    <input id="simulateCount" class="sim-input" type="number" min="1" value="100" />
                    <button id="simulateBtn" class="simulate-btn dev-btn" onclick="simulateBattlesFromUI()">Simulate</button>
                </div>
                <div id="simulateProgress" class="dev-progress" aria-hidden="true" style="display:none;margin-top:8px;font-size:0.9em;color:#4CA1AF;"></div>
            </div>

            <div class="dev-option" style="margin-top:12px;">
                <button id="devToggleDataBtn" class="dev-btn dev-toggle-data" onclick="toggleDevData()" aria-pressed="false">Show dev-data</button>
                
            </div>

            <div class="dev-option" style="margin-top:12px;">
                <div style="font-size:0.9em;color:#6B7280;margin-bottom:6px;font-weight:600;">Image Loading</div>
                <div id="imageLoadProgress" class="dev-progress" style="font-size:0.85em;color:#4CA1AF;font-weight:700;">
                    Loaded: 0 / 0 (0%)
                </div>
                <div id="imageLoadDetails" style="font-size:0.8em;color:#9CA3AF;margin-top:4px;">
                    Cache hits: 0 | Errors: 0
                </div>
                <button class="dev-btn" onclick="clearImageCache()" style="margin-top:8px;width:100%;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;">
                    Clear Image Cache
                </button>
            </div>

            <div class="dev-option" style="margin-top:8px;">
                <button id="forceCloseBtn" class="dev-btn" onclick="forceNextCloseFight()" title="Force a close fight">Force close fight</button>
            </div>

            <div class="dev-option" style="margin-top:12px;border-top:1px solid #ddd;padding-top:12px;">
                <div style="font-size:0.9em;font-weight:700;margin-bottom:12px;color:#111827;">Pairing Parameters</div>
                
                <div style="margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <label style="font-size:0.85em;color:#666;">Exploration Power</label>
                        <span id="explorationPowerValue" style="min-width:36px;text-align:center;font-weight:700;color:#2c3e50;font-size:0.9em;">2.0</span>
                    </div>
                    <input id="explorationPowerRange" type="range" min="0" max="5" step="0.1" value="2.0" oninput="setExplorationPower(this.value)" style="width:100%;">
                    <div style="font-size:0.75em;color:#888;margin-top:2px;">Higher = favor under-sampled coasters more</div>
                </div>

                <div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <label style="font-size:0.85em;color:#666;">ELO Proximity Power</label>
                        <span id="eloProximityValue" style="min-width:36px;text-align:center;font-weight:700;color:#2c3e50;font-size:0.9em;">0.1</span>
                    </div>
                    <input id="eloProximityRange" type="range" min="0" max="4" step="0.1" value="0.1" oninput="setEloProximityPower(this.value)" style="width:100%;">
                    <div style="font-size:0.75em;color:#888;margin-top:2px;">Higher = prefer opponents with similar ELO</div>
                </div>
            </div>

            <div class="dev-option" style="margin-top:12px;border-top:1px solid #ddd;padding-top:12px;">
                <button id="rankingWizardBtn" class="dev-btn" onclick="runRankingWizard()" title="Recalculate all battles with current K-factors">Ranking Wizard</button>
                <div id="rankingWizardProgress" class="dev-progress" style="display:none;margin-top:8px;font-size:0.9em;color:#4CA1AF;"></div>
            </div>

            <div class="dev-option" style="margin-top:12px;">
                <button class="reset-btn dev-reset-btn dev-btn" onclick="resetAllUserData()">Reset user data</button>
            </div>

            <div class="dev-option" style="margin-top:12px; display: flex; gap: 8px;">
                <button class="dev-btn" onclick="exportUserData()" style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    Export User Data
                </button>
                <button class="dev-btn" onclick="document.getElementById('importFileInput').click()" style="flex: 1; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                    Import User Data
                </button>
            </div>
            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importUserData(event)" />
        </div>
    </div>

    <!-- Close-battle full-screen overlay (visuals only; pointer-events:none so UI stays clickable) -->
    <div id="closeBattleOverlay" class="close-battle-overlay" aria-hidden="true">
        <div class="arena-lights"></div>
        <div class="arena-center">
            <div class="coaster-side" id="cLeft">
                <div class="coaster-name" id="cLeftName"></div>
            </div>
            <div class="vs-mark">VS</div>
            <div class="coaster-side" id="cRight">
                <div class="coaster-name" id="cRightName"></div>
            </div>
        </div>

        <div class="winner-burst" id="winnerBurst" aria-hidden="true">
            <div class="winner-text" id="winnerText">Winner!</div>
        </div>
        <div class="close-banner" id="closeBanner" aria-hidden="true">CLOSE FIGHT</div>
    </div>

    <script src="achievements.js"></script>
    <script src="script.js"></script>
</body></html>
