<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaster Ranker</title>
    <link rel="icon" href="/images/rollercoaster.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-inner">
                <div class="header-left">
                    <div class="current-user-badge" id="currentUserBadge">Select a user</div>
                </div>

                <div class="header-center">
                    <h1>Coaster Ranker</h1>
                </div>

                <div class="header-right">
                    <button id="userMenuToggle" class="hamburger-btn" aria-haspopup="true" aria-expanded="false" title="Choose user" onclick="toggleUserMenu()">‚ò∞</button>
                    <div id="userMenu" class="user-menu" aria-hidden="true">
                        <button class="user-btn" onclick="switchUser('luca')" id="btn-luca">üë§ Luca</button>
                        <button class="user-btn" onclick="switchUser('wouter')" id="btn-wouter">üë§ Wouter</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('battle')">Battle</button>
            <button class="tab" onclick="switchTab('ranking')">Ranking</button>
            <button class="tab" onclick="switchTab('history')">History</button>
        </div>

        <div id="battle-tab" class="tab-content active">
            <div class="vs-divider">VS</div>
            <div class="battle-area">
                <div class="battle-container" id="battleContainer">
                    <div class="no-battles">Select a user above first! üëÜ</div>
                </div>
    
            </div>
            <div class="pairing-controls-wrapper" style="margin:12px 0; display: none;">
                <div style="display:flex;justify-content:center;align-items:center;">
                    <div style="font-size:0.95em;color:#444;display:flex;align-items:center;gap:8px;"></div>
                    <button id="pairingControlsToggle" class="pairing-toggle-btn" onclick="togglePairingControls()" aria-expanded="true" title="Hide settings" style="margin-left:8px;padding:6px 8px;border-radius:8px;border:none;background:#fff;cursor:pointer;font-weight:700;">‚ñæ</button>
                </div>

                <div id="pairingControls" class="pairing-controls" style="display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:8px;transition:max-height 260ms ease,opacity 180ms ease;overflow:hidden;">
                    <div class="pair-toggle" style="display:flex;border:1px solid #ddd;border-radius:10px;overflow:hidden;">
                        <button class="pair-option" data-value="hybrid" data-help="first selects an undersampled coaster, then an opponent with similar ELO (balances exploration and refinement)" onclick="setPairingStrategy('hybrid')">
                            Hybrid
                        </button>
                        <button class="pair-option" data-value="exploration" data-help="both choices prioritize undersampled coasters (faster coverage)" onclick="setPairingStrategy('exploration')">
                            Exploration
                        </button>
                        <button class="pair-option" data-value="uniform" data-help="completely random (no bias)" onclick="setPairingStrategy('uniform')">
                            Uniform
                        </button>
                    </div>

                    <div style="display:flex;align-items:center;gap:8px;font-size:0.95em;color:#444;">
                        ELO-proximity:
                        <input id="eloProximityRange" type="range" min="0" max="4" step="0.1" value="1" oninput="setEloProximityPower(this.value)" style="width:180px;">
                        <span id="eloProximityValue" style="min-width:36px;text-align:center;font-weight:700;color:#2c3e50;">1.0</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="history-tab" class="tab-content">
            <div class="history-header-row">
                <div class="autocomplete-container">
                    <div class="search-input-wrapper">
                        <input id="historySearch" type="text" class="search-box" placeholder="üîç Search matchup..." oninput="handleHistorySearchInput()" onkeydown="handleHistorySearchKeydown(event)" onfocus="showHistoryAutocomplete()" style="width:100%;" />
                        <button id="clearHistorySearchBtn" class="clear-search-btn" onclick="clearHistorySearch()" style="display:none;" title="Clear search">‚úï</button>
                    </div>
                    <div id="historyAutocomplete" class="autocomplete-dropdown"></div>
                </div>
                <!-- History Filters: visible when a coaster is selected -->
                <div class="history-filters" id="historyFilters" aria-hidden="false">
                    <button class="filter-btn active" data-filter="all" onclick="setHistoryFilter('all')">All battles</button>
                    <button class="filter-btn" data-filter="wins" onclick="setHistoryFilter('wins')">Wins</button>
                    <button class="filter-btn" data-filter="losses" onclick="setHistoryFilter('losses')">Losses</button>
                    <button class="filter-btn" data-filter="close" onclick="setHistoryFilter('close')">Close fights</button>
                </div>
            </div>
            <div id="historyContainer" style="overflow:auto;">
                <div class="no-battles">No battles yet ‚Äî start choosing to build your history.</div>
            </div>
        </div>

        <div id="ranking-tab" class="tab-content">
            <div class="ranking-controls">
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-value" id="totalBattles">0</div>
                        <div class="stat-label">Total Battles</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalCoasters">0</div>
                        <div class="stat-label">Coasters</div>
                    </div>
                    <div class="stat-item" style="display: none;">
                        <div class="stat-value" id="avgBattlesPerCoaster">0</div>
                        <div class="stat-label">Avg. Battles/Coaster</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="progressMatchups">0/0</div>
                        <div class="stat-label">Matchups Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="progressPercentage">0%</div>
                        <div class="stat-label">Progress</div>
                    </div>
                </div>
            </div>

            <div class="filter-container">
                <input type="text" class="search-box" id="searchBox" placeholder="üîç Search coaster, park or manufacturer..." onkeyup="filterRanking()">
            </div>

            <table class="ranking-table" id="rankingTable">
                <thead>
                    <tr>
                        <th onclick="sortRanking('rank')">Rank</th>
                        <th onclick="sortRanking('name')">Name</th>
                        <th onclick="sortRanking('park')">Park</th>
                        <th onclick="sortRanking('manufacturer')">Manufacturer</th>
                        <th onclick="sortRanking('elo')">ELO ‚¨áÔ∏è</th>
                        <th onclick="sortRanking('battles')">Battles</th>
                        <th onclick="sortRanking('wins')">Wins</th>
                        <th onclick="sortRanking('losses')">Losses</th>
                        <th onclick="sortRanking('winrate')">Win %</th>
                    </tr>
                </thead>
                <tbody id="rankingBody">
                    <tr><td colspan="9" class="no-battles">Select a user first! üé¢</td></tr>
                </tbody>
            </table>

            <div class="reset-panel">
                <div class="reset-copy">Reset all rankings, battles and history for the current user.</div>
                <button class="reset-btn" onclick="resetRankings()">üîÑ Reset All</button>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="download-btn" onclick="downloadRankingCSV()" style="background: linear-gradient(135deg, #4CA1AF 0%, #2C3E50 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 1em; font-weight: 700; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 15px rgba(76, 161, 175, 0.3);">
                    üì• Download Ranking as CSV
                </button>
            </div>
        </div>
    </div>

</div>

    <!-- Developer button (bottom-left) -->
    <button id="devToggleBtn" class="dev-toggle dev-btn" aria-haspopup="true" aria-expanded="false" title="Developer options" onclick="toggleDevMenu()">
        <svg class="icon icon-gear" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false">
            <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zm8.2-3a6.7 6.7 0 0 0-.1-1l2.1-1.6-2-3.4-2.5.6a7 7 0 0 0-1.6-.9L15 2h-6l-.6 2.2c-.5.2-1 .5-1.6.9L4.3 4.5 2.3 7.9l2.1 1.6c-.1.3-.1.6-.1 1s0 .7.1 1L2.3 15.1 4.3 18.5l2.5-.6c.5.4 1.1.7 1.6.9L9 22h6l.6-2.2c.5-.2 1-.5 1.6-.9l2.5.6 2-3.4-2.1-1.6c.1-.3.1-.6.1-1z"/>
        </svg>
    </button>
    <div id="devMenu" class="dev-menu" aria-hidden="true" role="dialog" aria-label="Developer options">
        <div class="dev-menu-header">Developer Options</div>
        <div class="dev-menu-body">
            <div class="dev-option">
                <div style="display:flex;gap:8px;align-items:center;">
                    <input id="simulateCount" class="sim-input" type="number" min="1" value="100" />
                    <button id="simulateBtn" class="simulate-btn dev-btn" onclick="simulateBattlesFromUI()">Simulate</button>
                </div>
                <div id="simulateProgress" class="dev-progress" aria-hidden="true" style="display:none;margin-top:8px;font-size:0.9em;color:#4CA1AF;"></div>
            </div>

            <div class="dev-option" style="margin-top:12px;">
                <button id="devToggleDataBtn" class="dev-btn dev-toggle-data" onclick="toggleDevData()" aria-pressed="false">Show dev-data</button>
                
            </div>

            <div class="dev-option" style="margin-top:8px;">
                <button id="forceCloseBtn" class="dev-btn" onclick="forceNextCloseFight()" title="Force a close fight">Force close fight</button>
            </div>

            <div class="dev-option" style="margin-top:12px;">
                <button class="reset-btn dev-reset-btn dev-btn" onclick="resetAllUserData()">Reset user data</button>
            </div>
        </div>
    </div>

    <!-- Close-battle full-screen overlay (visuals only; pointer-events:none so UI stays clickable) -->
    <div id="closeBattleOverlay" class="close-battle-overlay" aria-hidden="true">
        <div class="arena-lights"></div>
        <div class="arena-center">
            <div class="coaster-side" id="cLeft">
                <div class="coaster-name" id="cLeftName"></div>
            </div>
            <div class="vs-mark">VS</div>
            <div class="coaster-side" id="cRight">
                <div class="coaster-name" id="cRightName"></div>
            </div>
        </div>

        <div class="winner-burst" id="winnerBurst" aria-hidden="true">
            <div class="winner-text" id="winnerText">Winner!</div>
        </div>
        <div class="close-banner" id="closeBanner" aria-hidden="true">CLOSE FIGHT</div>
    </div>

    <script src="script.js"></script>
</body></html>
